{% extends "base.html" %}

{% block title %}Image Browser - {{ directory }}{% endblock %}

{% block head_extra %}
<style>
    /* Custom styles for view_dir */
    .image-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
    .thumbnail { border: 1px solid #ccc; padding: 5px; text-align: center; }
    /* Ensure modal image fits */
    #imageModal .modal-body img { max-width: 100%; height: auto; max-height: 70vh; }
    
    /* Make sidebar sticky */
    .sidebar-sticky {
        position: -webkit-sticky; /* Safari */
        position: sticky;
        top: 5rem; /* Match body padding-top, adjust as needed */
        height: calc(100vh - 5rem); /* Adjust height based on top value */
        overflow-y: auto; /* Add scroll within sidebar if content exceeds height */
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <!-- Job Queue Sidebar (Left) -->
    <div class="col-md-3 sidebar-sticky">
        <h4>Job Queue</h4>
        <div id="job-queue-container" class="list-group">
            <!-- Jobs will be dynamically loaded here -->
            <h5>Active Jobs</h5>
            <div id="active-jobs-list" class="list-group mb-3">
                <p class="text-muted p-2">Loading...</p>
            </div>
            
            <h5>Finished Jobs</h5>
            <div id="finished-jobs-list" class="list-group">
                 <p class="text-muted p-2">Loading...</p>
            </div>
        </div>
    </div>

    <!-- Image Grid (Right) -->
    <div class="col-md-9">
        <h2>Images in: {{ directory }}</h2>
        <p><a href="{{ url_for('index') }}">Change Directory</a></p>
        
        {% if error %}
            <div class="alert alert-danger">Error: {{ error }}</div>
        {% endif %}

        {% if images %}
            <div class="image-grid">
                {% for image in images %}
                    <div class="thumbnail">
                        <img src="{{ url_for('serve_image', filename=image.path) }}" 
                             alt="{{ image.name }}" 
                             loading="lazy"
                             data-bs-toggle="modal" 
                             data-bs-target="#imageModal"
                             data-image-path="{{ image.path }}"
                             data-image-name="{{ image.name }}"
                             data-image-src="{{ url_for('serve_image', filename=image.path) }}">
                        <p>{{ image.name }}</p>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <p>No images found in this directory.</p>
        {% endif %}
    </div>
</div>

<!-- Image Generation Modal -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageModalLabel">Generate Video</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-7 text-center">
                        <img src="" alt="Selected Image" id="modalImagePreview" class="img-fluid mb-2">
                        <p><small id="modalImageName"></small></p>
                    </div>
                    <div class="col-md-5">
                        <form id="generateForm">
                            <input type="hidden" name="image_path" id="modalImagePath">
                            
                            <div class="mb-3">
                                <label for="prompt" class="form-label">Prompt:</label>
                                <textarea class="form-control" id="modalPrompt" name="prompt" rows="3">{{ default_prompt }}</textarea>
                            </div>
                            
                            <div class="mb-3">
                                <label for="duration" class="form-label">Duration (seconds, 1-{{ max_duration }}):</label>
                                <input type="number" class="form-control" id="duration" name="duration" min="1" max="{{ max_duration }}" value="{{ default_duration }}" required>
                            </div>
                            
                            <button type="submit" class="btn btn-primary">Queue Job</button>
                        </form>
                        <div id="modalMessage" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts_extra %}
<script>
    function submitGeneration() {
        const form = document.getElementById('generateForm');
        const formData = new FormData(form);
        const messageDiv = document.getElementById('modalMessage');
        messageDiv.textContent = 'Submitting job...';
        messageDiv.className = 'alert alert-info'; // Use Bootstrap classes

        fetch("{{ url_for('generate') }}", {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.job_id) {
                messageDiv.textContent = `Job submitted successfully! ID: ${data.job_id}`;
                messageDiv.className = 'alert alert-success';
                // Optionally close modal after a delay or redirect
                // setTimeout(() => { bootstrap.Modal.getInstance(document.getElementById('generationModal')).hide(); }, 2000);
            } else {
                messageDiv.textContent = `Error: ${data.error || 'Unknown error'}`;
                messageDiv.className = 'alert alert-danger';
            }
        })
        .catch(error => {
            console.error('Error submitting generation job:', error);
            messageDiv.textContent = `Error submitting job: ${error}`;
            messageDiv.className = 'alert alert-danger';
        });
    }
</script>
{% endblock %}
